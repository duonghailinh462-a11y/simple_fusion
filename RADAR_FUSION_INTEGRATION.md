# 雷达融合模块集成说明

## 概述

雷达融合模块已成功集成到 `main.py` 中，实现了三路摄像头融合 + 雷达数据融合的统一架构。

## 架构设计

### 数据流

```
3路视频流 → SDK推理 → 本地跟踪(BYTETracker) → 摄像头融合(CrossCameraFusion) 
                                                              ↓
                                                    雷达融合(RadarVisionFusion)
                                                              ↓
                                                        输出(JSON/MQTT)
```

### 关键特性

1. **异步融合策略**
   - 视频帧实时处理，不等待雷达数据
   - 雷达数据到达时，基于时间戳匹配最近的视频帧
   - 避免了帧率不匹配导致的延迟问题（视频25fps vs 雷达5fps）

2. **简化的融合逻辑**
   - 雷达仅用于匹配，不输出坐标
   - 坐标来自视觉（摄像头标定）
   - 只需填充 `radar_id` 字段

3. **统一的输出格式**
   ```json
   {
     "timestamp": "2025-11-21 11:17:58.064",
     "cameraid": 2,
     "type": "car",
     "confidence": 0.8361160755157471,
     "track_id": 68,
     "radar_id": "00000062-6e1c-4106-bd10-d969000df95d",
     "lon": 113.58414362960251,
     "lat": 23.530363319836336
   }
   ```

## 文件说明

### 新增文件

1. **RadarVisionFusion.py** - 雷达融合核心模块
   - `RadarVisionFusionProcessor`: 雷达融合处理器
   - `RadarDataLoader`: 雷达数据加载器
   - `OutputObject`: 统一输出对象
   - `RadarObject`: 雷达目标对象

2. **test_radar_fusion.py** - 测试脚本
   - 测试雷达融合功能
   - 验证数据加载和匹配逻辑

### 修改文件

1. **main.py**
   - 导入雷达融合模块
   - 初始化雷达数据加载器和融合处理器
   - 在主循环中集成雷达融合逻辑
   - 传递 `radar_id_map` 给 `generate_json_data`

2. **Fusion.py**
   - 修改 `generate_json_data` 方法
   - 添加 `radar_id_map` 参数
   - 更新输出格式以包含 `radar_id` 字段

## 配置说明

### 雷达数据路径

在 `main.py` 中配置雷达数据文件路径：

```python
radar_data_path = 'c:/Users/zhenghuiwen1/Desktop/project_simple/radar_vision/radar_data_85_aligned.jsonl'
```

### 融合区域配置

配置融合区域（地理坐标多边形）：

```python
fusion_area_geo = [
    [113.583894894, 23.530394880],
    [113.584462681, 23.530850485],
    [113.584032327, 23.530886446],
    [113.583922645, 23.530898319]
]
```

### 坐标偏移

配置坐标校准偏移：

```python
lat_offset = -0.00000165
lon_offset = 0.0000450
```

## 使用方法

### 1. 运行主程序

```bash
python main.py
```

如果雷达数据文件存在，将自动启用雷达融合功能。

### 2. 测试雷达融合模块

```bash
python test_radar_fusion.py
```

### 3. 禁用雷达融合

如果不需要雷达融合，只需：
- 删除或移动雷达数据文件
- 或者在代码中设置 `radar_fusion_enabled = False`

## 性能优化

### 时间复杂度

- **雷达数据加载**: O(N) - N为雷达帧数
- **时间戳匹配**: O(M) - M为雷达缓冲区大小（最多100帧）
- **目标匹配**: O(R × V) - R为雷达目标数，V为视觉目标数

### 内存优化

- 雷达缓冲区最多保留100个时间戳
- 自动清理过期数据（1秒以上）

## 输出示例

### 无雷达匹配

```json
{
  "timestamp": "2025-11-21 11:17:58.064",
  "cameraid": 1,
  "type": "car",
  "confidence": 0.85,
  "track_id": 1,
  "radar_id": null,
  "lon": 113.584143,
  "lat": 23.530363
}
```

### 有雷达匹配

```json
{
  "timestamp": "2025-11-21 11:17:58.064",
  "cameraid": 2,
  "type": "car",
  "confidence": 0.836,
  "track_id": 68,
  "radar_id": "00000062-6e1c-4106-bd10-d969000df95d",
  "lon": 113.584144,
  "lat": 23.530363
}
```

## 调试信息

### 启动时

```
🔧 初始化雷达融合模块...
✅ 加载雷达数据完成: 1234 帧
✅ 雷达融合模块初始化成功
   雷达数据帧数: 1234
```

### 运行时（每100帧）

```
🔗 Frame 100: 雷达匹配 5/10 个目标
🔗 Frame 200: 雷达匹配 7/12 个目标
```

## 故障排除

### 问题1: 雷达数据加载失败

**原因**: 文件路径错误或文件格式不正确

**解决方案**:
- 检查文件路径是否正确
- 确认文件格式为 JSONL（每行一个JSON对象）
- 检查文件编码为 UTF-8

### 问题2: 匹配率低

**原因**: 融合区域配置不正确或坐标偏移不准确

**解决方案**:
- 调整 `fusion_area_geo` 配置
- 调整 `lat_offset` 和 `lon_offset`
- 检查摄像头标定参数

### 问题3: 性能下降

**原因**: 雷达目标数量过多

**解决方案**:
- 增加融合区域过滤
- 调整匹配阈值
- 减少雷达缓冲区大小

## 未来优化

1. **多融合区域支持**
   - 为每个摄像头配置独立的融合区域
   - 支持动态融合区域

2. **自适应阈值**
   - 根据目标速度动态调整匹配阈值
   - 根据匹配历史调整忠诚度奖励

3. **性能监控**
   - 添加雷达融合性能指标
   - 实时监控匹配率和处理时间

4. **可视化**
   - 添加雷达融合可视化
   - 显示匹配关系和融合区域

## 参考

- `main_1127.py`: 原始雷视融合实现
- `main.py`: 三路摄像头融合实现
- `RadarVisionFusion.py`: 雷达融合模块
- `Fusion.py`: 摄像头融合模块
